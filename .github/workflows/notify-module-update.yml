name: Notify Module Update

# Reusable workflow for Puppet modules to trigger r10k pipeline
# Usage in puppet module:
#
#   on:
#     push:
#       branches: [main]
#
#   jobs:
#     notify:
#       uses: slauger/r10k-github-actions/.github/workflows/notify-module-update.yml@production
#       secrets:
#         GH_APP_ID: ${{ secrets.GH_APP_ID }}
#         GH_APP_PRIVATE_KEY: ${{ secrets.GH_APP_PRIVATE_KEY }}

on:
  workflow_call:
    inputs:
      target_repo:
        description: 'Target repository to trigger (owner/repo)'
        required: false
        type: string
        default: 'slauger/r10k-github-actions'
      environment:
        description: 'Environment to build and deploy (production, qa, test)'
        required: false
        type: string
        default: 'production'
    secrets:
      GH_APP_ID:
        required: true
      GH_APP_PRIVATE_KEY:
        required: true

jobs:
  trigger:
    name: Trigger r10k Pipeline
    runs-on: ubuntu-latest

    steps:
      - name: Generate GitHub App Token
        id: generate-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Trigger r10k-github-actions pipeline
        env:
          GH_TOKEN: ${{ steps.generate-token.outputs.token }}
        run: |
          echo "Triggering r10k pipeline for module: ${{ github.repository }}"
          echo "Target repository: ${{ inputs.target_repo }}"
          echo "Environment: ${{ inputs.environment }}"

          curl -X POST \
            -H "Authorization: token ${GH_TOKEN}" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/repos/${{ inputs.target_repo }}/dispatches \
            -d '{
              "event_type": "puppet-module-updated",
              "client_payload": {
                "module": "${{ github.repository }}",
                "module_name": "${{ github.event.repository.name }}",
                "ref": "${{ github.ref }}",
                "sha": "${{ github.sha }}",
                "environment": "${{ inputs.environment }}",
                "triggered_by": "${{ github.actor }}"
              }
            }'

          echo "Pipeline triggered successfully"
