name: Deploy Puppet Environment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy (production, qa, test, or test_*)'
        required: true
        type: choice
        options:
          - production
          - qa
          - test
        default: 'production'
      artifact_name:
        description: 'Artifact name to deploy (leave empty to use latest from environment branch)'
        required: false
        type: string
      target_servers:
        description: 'Target Puppet servers (comma-separated hostnames/IPs)'
        required: true
        type: string
        default: 'puppet.example.com'
      rsync_user:
        description: 'SSH user for rsync deployment'
        required: false
        type: string
        default: 'root'
      puppet_admin_api_port:
        description: 'Puppet Admin API port'
        required: false
        type: string
        default: '8140'

jobs:
  deploy:
    name: Deploy to Puppet Servers
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          # If artifact_name is provided, use it; otherwise download the latest
          name: ${{ inputs.artifact_name || format('puppet-environment-{0}-', inputs.environment) }}
          path: ./downloaded-artifact

      - name: Prepare deployment directory
        run: |
          echo "Preparing deployment structure..."
          mkdir -p deployment/code/environments

          # Copy the downloaded artifact
          if [ -d "downloaded-artifact/environments" ]; then
            cp -r downloaded-artifact/environments/* deployment/code/environments/
          else
            cp -r downloaded-artifact/* deployment/code/environments/
          fi

          echo "Deployment directory prepared:"
          ls -lah deployment/code/environments/

      - name: Deploy to Puppet servers via rsync
        run: |
          ENV_NAME="${{ inputs.environment }}"
          TARGETS="${{ inputs.target_servers }}"
          RSYNC_USER="${{ inputs.rsync_user }}"

          echo "Deploying environment '${ENV_NAME}' to servers: ${TARGETS}"

          # Split comma-separated servers
          IFS=',' read -ra SERVERS <<< "$TARGETS"

          for SERVER in "${SERVERS[@]}"; do
            SERVER=$(echo "$SERVER" | xargs) # trim whitespace
            echo "=== Deploying to ${SERVER} ==="

            # Create backup of existing environment
            ssh ${RSYNC_USER}@${SERVER} "mkdir -p /etc/puppetlabs/code/environments-backup && \
              if [ -d /etc/puppetlabs/code/environments/${ENV_NAME} ]; then \
                cp -a /etc/puppetlabs/code/environments/${ENV_NAME} \
                  /etc/puppetlabs/code/environments-backup/${ENV_NAME}-\$(date +%Y%m%d-%H%M%S); \
              fi"

            # Sync the environment
            rsync -avz --delete \
              --exclude='.git' \
              --exclude='.g10k' \
              deployment/code/environments/${ENV_NAME}/ \
              ${RSYNC_USER}@${SERVER}:/etc/puppetlabs/code/environments/${ENV_NAME}/

            echo "Deployment to ${SERVER} completed successfully"
          done

      - name: Clear Puppet environment cache
        run: |
          ENV_NAME="${{ inputs.environment }}"
          TARGETS="${{ inputs.target_servers }}"
          API_PORT="${{ inputs.puppet_admin_api_port }}"

          echo "Clearing environment cache for '${ENV_NAME}'"

          # Split comma-separated servers
          IFS=',' read -ra SERVERS <<< "$TARGETS"

          for SERVER in "${SERVERS[@]}"; do
            SERVER=$(echo "$SERVER" | xargs) # trim whitespace
            echo "=== Clearing cache on ${SERVER} ==="

            # Clear environment cache using Puppet Admin API
            # Using the local Puppet certificate for authentication
            ssh ${RSYNC_USER}@${SERVER} "curl -X DELETE \
              --cert /etc/puppetlabs/puppet/ssl/certs/\$(hostname -f).pem \
              --key /etc/puppetlabs/puppet/ssl/private_keys/\$(hostname -f).pem \
              --cacert /etc/puppetlabs/puppet/ssl/certs/ca.pem \
              https://localhost:${API_PORT}/puppet-admin-api/v1/environment-cache?environment=${ENV_NAME}" || {
                echo "Warning: Failed to clear cache on ${SERVER}"
                echo "You may need to manually run: puppetserver reload or service puppetserver reload"
              }

            echo "Cache cleared on ${SERVER}"
          done

      - name: Verify deployment
        run: |
          ENV_NAME="${{ inputs.environment }}"
          TARGETS="${{ inputs.target_servers }}"
          RSYNC_USER="${{ inputs.rsync_user }}"

          echo "Verifying deployment on all servers..."

          IFS=',' read -ra SERVERS <<< "$TARGETS"

          for SERVER in "${SERVERS[@]}"; do
            SERVER=$(echo "$SERVER" | xargs)
            echo "=== Verifying ${SERVER} ==="

            ssh ${RSYNC_USER}@${SERVER} "ls -lah /etc/puppetlabs/code/environments/${ENV_NAME}/ && \
              echo 'Environment ${ENV_NAME} structure:' && \
              find /etc/puppetlabs/code/environments/${ENV_NAME}/ -maxdepth 2 -type d"

            echo "Verification completed for ${SERVER}"
          done

      - name: Deployment summary
        run: |
          ENV_NAME="${{ inputs.environment }}"
          TARGETS="${{ inputs.target_servers }}"

          echo "### Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${ENV_NAME}" >> $GITHUB_STEP_SUMMARY
          echo "- **Target Servers:** ${TARGETS}" >> $GITHUB_STEP_SUMMARY
          echo "- **Artifact:** ${{ inputs.artifact_name || 'latest' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed at:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Actions performed" >> $GITHUB_STEP_SUMMARY
          echo "1. Environment backed up to environments-backup/" >> $GITHUB_STEP_SUMMARY
          echo "2. Files synced via rsync to /etc/puppetlabs/code/environments/${ENV_NAME}/" >> $GITHUB_STEP_SUMMARY
          echo "3. Environment cache cleared via Puppet Admin API" >> $GITHUB_STEP_SUMMARY
          echo "4. Deployment verified on all servers" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> **Note:** If cache clearing failed, manually run: \`puppetserver reload\`" >> $GITHUB_STEP_SUMMARY
