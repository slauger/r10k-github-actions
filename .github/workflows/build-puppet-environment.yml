name: Puppet Environment CI/CD

on:
  push:
    branches:
      - production
      - qa
      - test
      - 'test_**'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy (production, qa, test, or test_*)'
        required: true
        type: string
        default: 'production'
      skip_deploy:
        description: 'Skip deployment (build only)'
        required: false
        type: boolean
        default: false

env:
  G10K_VERSION: '0.9.9'

# Ensure only one deployment runs at a time per environment
concurrency:
  group: puppet-${{ github.event_name == 'workflow_dispatch' && inputs.environment || github.ref_name }}
  cancel-in-progress: false

jobs:
  build:
    name: Build Puppet Environment with g10k
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate GitHub App Token
        id: generate-token
        continue-on-error: true
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.GH_APP_ID }}
          private-key: ${{ secrets.GH_APP_PRIVATE_KEY }}

      - name: Configure Git credentials for private repositories
        if: steps.generate-token.outcome == 'success'
        run: |
          git config --global credential.helper store
          echo "https://x-access-token:${{ steps.generate-token.outputs.token }}@github.com" > ~/.git-credentials
          git config --global url."https://github.com/".insteadOf "git@github.com:"

      - name: Set environment name from branch or input
        id: set-env
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ENV_NAME="${{ inputs.environment }}"
          else
            ENV_NAME="${GITHUB_REF#refs/heads/}"
          fi
          echo "branch_name=${ENV_NAME}" >> $GITHUB_OUTPUT
          echo "Environment: ${ENV_NAME}"

      - name: Cache g10k modules
        uses: actions/cache@v4
        with:
          path: .g10k/cache
          key: g10k-cache-${{ github.ref_name }}
          restore-keys: |
            g10k-cache-

      - name: Install g10k
        run: |
          echo "Installing g10k version ${G10K_VERSION}"
          wget -q https://github.com/xorpaul/g10k/releases/download/v${G10K_VERSION}/g10k-linux-amd64.zip
          unzip -q g10k-linux-amd64.zip
          chmod +x g10k
          sudo mv g10k /usr/local/bin/
          g10k -version

      - name: Create output directory structure
        run: |
          ENV_NAME="${{ steps.set-env.outputs.branch_name }}"
          mkdir -p output/environments/${ENV_NAME}
          echo "Created directory structure for environment: ${ENV_NAME}"

      - name: Copy environment files
        run: |
          ENV_NAME="${{ steps.set-env.outputs.branch_name }}"
          ENV_DIR="output/environments/${ENV_NAME}"

          # Copy Puppetfile
          cp Puppetfile ${ENV_DIR}/

          # Copy manifests
          cp -r manifests ${ENV_DIR}/

          # Copy local modules
          cp -r modules ${ENV_DIR}/

          echo "Environment files copied to ${ENV_DIR}"

      - name: Create g10k config for this environment
        run: |
          ENV_NAME="${{ steps.set-env.outputs.branch_name }}"
          cat > g10k-run.yaml <<EOF
          cachedir: '.g10k/cache'

          git:
            privatekey: ''

          sources:
            puppet:
              basedir: './output/environments/${ENV_NAME}'
              prefix: false

          forge:
            baseurl: 'https://forge.puppet.com'

          deploy:
            purge_levels: ['deployment', 'puppetfile']

          maxworker: 50
          use_cache: true
          EOF

          cat g10k-run.yaml

      - name: Run g10k to fetch Puppet modules
        run: |
          ENV_NAME="${{ steps.set-env.outputs.branch_name }}"

          # Create a temporary Puppetfile config for g10k
          cat > g10k-puppetfile.yaml <<EOF
          cachedir: '.g10k/cache'

          sources:
            puppet:
              basedir: './output/environments'
              environments:
                ${ENV_NAME}:
                  puppetfile: './Puppetfile'

          forge:
            baseurl: 'https://forge.puppet.com'

          maxworker: 50
          EOF

          # Run g10k
          g10k -config g10k-puppetfile.yaml -verbose

          echo "Modules fetched successfully"

      - name: List generated environment structure
        run: |
          ENV_NAME="${{ steps.set-env.outputs.branch_name }}"
          echo "=== Environment structure for ${ENV_NAME} ==="
          ls -lah output/environments/${ENV_NAME}/
          echo ""
          echo "=== Modules in forge directory ==="
          ls -lah output/environments/${ENV_NAME}/forge/ || echo "No forge directory"

      - name: Create final artifact structure
        run: |
          ENV_NAME="${{ steps.set-env.outputs.branch_name }}"

          # Create the final code directory structure
          mkdir -p artifact/code/environments

          # Copy the built environment
          cp -r output/environments/${ENV_NAME} artifact/code/environments/

          # Create environment.conf if it doesn't exist
          if [ ! -f artifact/code/environments/${ENV_NAME}/environment.conf ]; then
            cat > artifact/code/environments/${ENV_NAME}/environment.conf <<EOF
          # Environment configuration
          modulepath = modules:forge:\$basemodulepath
          manifest = manifests/site.pp
          EOF
          fi

          echo "Final artifact structure created"
          du -sh artifact/code/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: puppet-environment-${{ steps.set-env.outputs.branch_name }}-${{ github.sha }}
          path: artifact/code/
          retention-days: 30
          compression-level: 9

      - name: Build summary
        run: |
          ENV_NAME="${{ steps.set-env.outputs.branch_name }}"
          echo "### Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${ENV_NAME}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${GITHUB_SHA}" >> $GITHUB_STEP_SUMMARY
          echo "- **Artifact:** puppet-environment-${ENV_NAME}-${GITHUB_SHA}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Environment Structure" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          tree -L 3 artifact/code/ || find artifact/code/ -maxdepth 3 -print
          echo '```' >> $GITHUB_STEP_SUMMARY

  deploy:
    name: Deploy to Puppet Servers
    runs-on: self-hosted
    needs: build
    # Only deploy on push to main branches, or on manual trigger if skip_deploy is false
    if: |
      (github.event_name == 'push' && (
        github.ref == 'refs/heads/production' ||
        github.ref == 'refs/heads/qa' ||
        github.ref == 'refs/heads/test' ||
        startsWith(github.ref, 'refs/heads/test_')
      )) ||
      (github.event_name == 'workflow_dispatch' && !inputs.skip_deploy)

    # Use variables from the build job
    env:
      ENV_NAME: ${{ needs.build.outputs.environment_name }}

    steps:
      - name: Validate required variables and secrets
        run: |
          ERRORS=0

          # Check required variables
          if [ -z "${{ vars.PUPPET_SERVERS }}" ]; then
            echo "❌ ERROR: PUPPET_SERVERS variable is not set"
            echo "   Please configure it in Settings → Secrets and variables → Actions → Variables"
            ERRORS=$((ERRORS + 1))
          else
            echo "✅ PUPPET_SERVERS is configured: ${{ vars.PUPPET_SERVERS }}"
          fi

          # Check optional variables
          if [ -z "${{ vars.PUPPET_RSYNC_USER }}" ]; then
            echo "⚠️  WARNING: PUPPET_RSYNC_USER not set, using default 'root'"
          else
            echo "✅ PUPPET_RSYNC_USER is configured: ${{ vars.PUPPET_RSYNC_USER }}"
          fi

          if [ -z "${{ vars.PUPPET_ADMIN_API_PORT }}" ]; then
            echo "⚠️  WARNING: PUPPET_ADMIN_API_PORT not set, using default '8140'"
          else
            echo "✅ PUPPET_ADMIN_API_PORT is configured: ${{ vars.PUPPET_ADMIN_API_PORT }}"
          fi

          # Check SSH key secret
          if [ -z "${{ secrets.PUPPET_DEPLOY_SSH_KEY }}" ]; then
            echo "❌ ERROR: PUPPET_DEPLOY_SSH_KEY secret is not set"
            echo "   Please configure it in Settings → Secrets and variables → Actions → Secrets"
            echo "   Or ensure your self-hosted runner has SSH keys configured"
            ERRORS=$((ERRORS + 1))
          else
            echo "✅ PUPPET_DEPLOY_SSH_KEY secret is configured"
          fi

          # Exit if there are errors
          if [ $ERRORS -gt 0 ]; then
            echo ""
            echo "❌ Deployment cannot proceed due to $ERRORS error(s)"
            exit 1
          fi

          echo ""
          echo "✅ All required configuration is present"

      - name: Setup SSH key for deployment
        run: |
          # Start ssh-agent and add key directly from secret (never touches disk)
          eval "$(ssh-agent -s)"
          echo "${{ secrets.PUPPET_DEPLOY_SSH_KEY }}" | ssh-add -

          # Export SSH_AUTH_SOCK for subsequent steps
          echo "SSH_AUTH_SOCK=$SSH_AUTH_SOCK" >> $GITHUB_ENV
          echo "SSH_AGENT_PID=$SSH_AGENT_PID" >> $GITHUB_ENV

          # Configure SSH settings
          mkdir -p ~/.ssh
          cat >> ~/.ssh/config <<EOF
          Host *
            StrictHostKeyChecking accept-new
            UserKnownHostsFile ~/.ssh/known_hosts
          EOF
          chmod 600 ~/.ssh/config

      - name: Set environment variables
        id: set-vars
        run: |
          # Get environment name from build job or input
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            ENV_NAME="${{ inputs.environment }}"
          else
            ENV_NAME="${GITHUB_REF#refs/heads/}"
          fi
          echo "env_name=${ENV_NAME}" >> $GITHUB_OUTPUT

          # Set target servers - always deploy to all Puppet servers
          echo "target_servers=${{ vars.PUPPET_SERVERS || 'puppet.example.com' }}" >> $GITHUB_OUTPUT
          echo "rsync_user=${{ vars.PUPPET_RSYNC_USER || 'root' }}" >> $GITHUB_OUTPUT
          echo "api_port=${{ vars.PUPPET_ADMIN_API_PORT || '8140' }}" >> $GITHUB_OUTPUT

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: puppet-environment-${{ steps.set-vars.outputs.env_name }}-${{ github.sha }}
          path: ./artifact

      - name: Verify artifact structure
        run: |
          echo "Artifact structure:"
          ls -lah artifact/

          if [ -d "artifact/environments" ]; then
            echo "Artifact contains environments directory"
            ls -lah artifact/environments/
          else
            echo "Artifact is environment directory"
          fi

      - name: Deploy to Puppet servers via rsync
        run: |
          ENV_NAME="${{ steps.set-vars.outputs.env_name }}"
          TARGETS="${{ steps.set-vars.outputs.target_servers }}"
          RSYNC_USER="${{ steps.set-vars.outputs.rsync_user }}"

          echo "Deploying environment '${ENV_NAME}' to servers: ${TARGETS}"

          # Split comma-separated servers
          IFS=',' read -ra SERVERS <<< "$TARGETS"

          for SERVER in "${SERVERS[@]}"; do
            SERVER=$(echo "$SERVER" | xargs) # trim whitespace
            echo "=== Deploying to ${SERVER} ==="

            # Create backup of existing environment
            ssh ${RSYNC_USER}@${SERVER} "mkdir -p /etc/puppetlabs/code/environments-backup && \
              if [ -d /etc/puppetlabs/code/environments/${ENV_NAME} ]; then \
                cp -a /etc/puppetlabs/code/environments/${ENV_NAME} \
                  /etc/puppetlabs/code/environments-backup/${ENV_NAME}-\$(date +%Y%m%d-%H%M%S); \
              fi"

            # Sync the environment
            rsync -avz --delete-after \
              --exclude='.git' \
              --exclude='.g10k' \
              artifact/environments/${ENV_NAME}/ \
              ${RSYNC_USER}@${SERVER}:/etc/puppetlabs/code/environments/${ENV_NAME}/

            echo "Deployment to ${SERVER} completed successfully"
          done

      - name: Clear Puppet environment cache
        run: |
          ENV_NAME="${{ steps.set-vars.outputs.env_name }}"
          TARGETS="${{ steps.set-vars.outputs.target_servers }}"
          RSYNC_USER="${{ steps.set-vars.outputs.rsync_user }}"
          API_PORT="${{ steps.set-vars.outputs.api_port }}"

          echo "Clearing environment cache for '${ENV_NAME}'"

          # Split comma-separated servers
          IFS=',' read -ra SERVERS <<< "$TARGETS"

          for SERVER in "${SERVERS[@]}"; do
            SERVER=$(echo "$SERVER" | xargs) # trim whitespace
            echo "=== Clearing cache on ${SERVER} ==="

            # Clear environment cache using Puppet Admin API
            ssh ${RSYNC_USER}@${SERVER} "curl -X DELETE \
              --cert /etc/puppetlabs/puppet/ssl/certs/\$(hostname -f).pem \
              --key /etc/puppetlabs/puppet/ssl/private_keys/\$(hostname -f).pem \
              --cacert /etc/puppetlabs/puppet/ssl/certs/ca.pem \
              https://localhost:${API_PORT}/puppet-admin-api/v1/environment-cache?environment=${ENV_NAME}" || {
                echo "Warning: Failed to clear cache on ${SERVER}"
                echo "You may need to manually run: puppetserver reload"
              }

            echo "Cache cleared on ${SERVER}"
          done

      - name: Verify deployment
        run: |
          ENV_NAME="${{ steps.set-vars.outputs.env_name }}"
          TARGETS="${{ steps.set-vars.outputs.target_servers }}"
          RSYNC_USER="${{ steps.set-vars.outputs.rsync_user }}"

          echo "Verifying deployment on all servers..."

          IFS=',' read -ra SERVERS <<< "$TARGETS"

          for SERVER in "${SERVERS[@]}"; do
            SERVER=$(echo "$SERVER" | xargs)
            echo "=== Verifying ${SERVER} ==="

            ssh ${RSYNC_USER}@${SERVER} "ls -lah /etc/puppetlabs/code/environments/${ENV_NAME}/ && \
              echo 'Environment ${ENV_NAME} structure:' && \
              find /etc/puppetlabs/code/environments/${ENV_NAME}/ -maxdepth 2 -type d"

            echo "Verification completed for ${SERVER}"
          done

      - name: Deployment summary
        run: |
          ENV_NAME="${{ steps.set-vars.outputs.env_name }}"
          TARGETS="${{ steps.set-vars.outputs.target_servers }}"

          echo "### Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment:** ${ENV_NAME}" >> $GITHUB_STEP_SUMMARY
          echo "- **Target Servers:** ${TARGETS}" >> $GITHUB_STEP_SUMMARY
          echo "- **Artifact:** puppet-environment-${ENV_NAME}-${GITHUB_SHA}" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed at:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "#### Actions performed" >> $GITHUB_STEP_SUMMARY
          echo "1. Environment backed up to environments-backup/" >> $GITHUB_STEP_SUMMARY
          echo "2. Files synced via rsync to /etc/puppetlabs/code/environments/${ENV_NAME}/" >> $GITHUB_STEP_SUMMARY
          echo "3. Environment cache cleared via Puppet Admin API" >> $GITHUB_STEP_SUMMARY
          echo "4. Deployment verified on all servers" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> **Note:** If cache clearing failed, manually run: \`puppetserver reload\`" >> $GITHUB_STEP_SUMMARY
